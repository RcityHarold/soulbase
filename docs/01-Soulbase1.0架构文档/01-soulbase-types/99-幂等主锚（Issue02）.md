# 幂等主锚（Issue 02 对齐）

> 本附录在不改变原有章节结构的前提下，明确 SB-01 的幂等与关联约定，用于为 SB-10/14/15/19 提供统一的 SSoT 依据。

## 统一原则

- 主锚唯一：全链路幂等“主锚”= `Envelope.envelope_id`（建议 UUIDv7/128bit）。
- 次级锚点：`Idempotency-Key` 与 `(channel, seq)` 仅作客户端/通道侧的二级校验或提示，不作为跨模块去重依据。
- 贯穿携带：`envelope_id` 作为可审计字段，应在 Evidence/账页/回执/出站请求头（`X-Env-Id`）中贯穿记录。

## 生成与传播

- 生成：拦截面在入站确定 `envelope_id`；A2A 入站若存在外部 `envelope_id`，需进行规范化与冲突校验（不同 `tenant` 不得复用）。
- 传播：
  - 内部调用与事件：`Envelope<T>` 持续传递 `envelope_id`；
  - 出站 HTTP：通过 `X-Env-Id` 注入；
  - A2A：作为反重放与收据链的主判定键；
  - 账页/证据：作为主键或唯一索引的一部分持久化。

## 验收要点（契约）

- 同一 `envelope_id` 的重复请求不应产生重复账页项、重复 Outbox 投递或重复副作用。
- 观测可见 `dedup_hits` 指标，且与重试次数相匹配。
- 合同测试覆盖“重试 3 次仅 1 次生效”。

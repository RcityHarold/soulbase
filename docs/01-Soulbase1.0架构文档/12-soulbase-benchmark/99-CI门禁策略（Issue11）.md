# CI 门禁策略（Issue 11 对齐）

> 在不改变原文结构的前提下，明确 PR 与 Nightly 的基线与范围：PR 只跑“核心契约小集 + 短基准”，Nightly 全量回归；失败日志可定位到契约断言。

## 执行分层

- PR（快速反馈）：
  - 契约小集：核心正向 + 高价值负向（错误码映射/幂等/沙箱拒绝/快照一致/Net 幂等重试等）。
  - 短基准：主要路径 p95/p99 烟囱指标（LLM 代理最短链、Tools 预检、Outbox 提交、Net GET）。
  - 跳过：长耗时、全量组合、跨域慢链、压力与可靠性长测。
- Nightly（全面回归）：
  - 全量契约与集成用例；
  - 复杂边界与对账；
  - 压力/可靠性基准；

## 失败诊断与日志

- 失败输出必须包含：契约编号/断言名称/期望与实际/相关上下文字段（白名单）。
- 禁止输出敏感原文（token/密钥/明文）；
- 提供 `--verbose`/`--json` 输出模式，便于 CI 收敛。

## 阈值与预算

- PR 用时目标：≤ N 分钟（团队约定）；
- 重试预算：对幂等重试相关用例限定最大重试次数，避免放大；
- 夜间窗口：Nightly 总时长 ≤ M 分钟（团队约定），超限需拆分并行。

## 结构建议

- `ci/examples/`：存放最小可运行样例与脚本；
- `ci/contracts/`：契约小集清单（标签化选择，如 `--tags=core,negative-highvalue`）。

## 验收

- PR 时间达标，失败日志可定位到契约断言；
- Nightly 全量通过，仪表含 p95/p99 趋势；
- 敏感信息未泄露；
- 标签选择与跳过策略能稳定收敛。
